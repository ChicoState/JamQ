'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _helpers = require('../../formatter/helpers');

var _command_types = require('./command_types');

var _command_types2 = _interopRequireDefault(_command_types);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _serializeError = require('serialize-error');

var _serializeError2 = _interopRequireDefault(_serializeError);

var _stack_trace_filter = require('../stack_trace_filter');

var _stack_trace_filter2 = _interopRequireDefault(_stack_trace_filter);

var _support_code_library_builder = require('../../support_code_library_builder');

var _support_code_library_builder2 = _interopRequireDefault(_support_code_library_builder);

var _test_case_runner = require('../test_case_runner');

var _test_case_runner2 = _interopRequireDefault(_test_case_runner);

var _user_code_runner = require('../../user_code_runner');

var _user_code_runner2 = _interopRequireDefault(_user_code_runner);

var _verror = require('verror');

var _verror2 = _interopRequireDefault(_verror);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var EVENTS = ['test-case-prepared', 'test-case-started', 'test-step-started', 'test-step-attachment', 'test-step-finished', 'test-case-finished'];

function serializeResultExceptionIfNecessary(data) {
  if (data.result && data.result.exception && _lodash2.default.isError(data.result.exception)) {
    data.result.exception = (0, _serializeError2.default)(data.result.exception);
  }
}

var Slave = function () {
  function Slave(_ref) {
    var _this = this;

    var cwd = _ref.cwd,
        exit = _ref.exit,
        sendMessage = _ref.sendMessage;
    (0, _classCallCheck3.default)(this, Slave);

    this.initialized = false;
    this.cwd = cwd;
    this.exit = exit;
    this.sendMessage = sendMessage;
    this.eventBroadcaster = new _events2.default();
    this.stackTraceFilter = new _stack_trace_filter2.default();
    EVENTS.forEach(function (name) {
      _this.eventBroadcaster.on(name, function (data) {
        serializeResultExceptionIfNecessary(data);
        _this.sendMessage({ command: _command_types2.default.EVENT, name: name, data: data });
      });
    });
  }

  (0, _createClass3.default)(Slave, [{
    key: 'initialize',
    value: function () {
      var _ref3 = (0, _bluebird.coroutine)(function* (_ref2) {
        var filterStacktraces = _ref2.filterStacktraces,
            supportCodeRequiredModules = _ref2.supportCodeRequiredModules,
            supportCodePaths = _ref2.supportCodePaths,
            worldParameters = _ref2.worldParameters;

        supportCodeRequiredModules.map(function (module) {
          return require(module);
        });
        _support_code_library_builder2.default.reset(this.cwd);
        supportCodePaths.forEach(function (codePath) {
          return require(codePath);
        });
        this.supportCodeLibrary = _support_code_library_builder2.default.finalize();
        this.worldParameters = worldParameters;
        this.filterStacktraces = filterStacktraces;
        if (this.filterStacktraces) {
          this.stackTraceFilter.filter();
        }
        yield this.runTestRunHooks('beforeTestRunHookDefinitions', 'a BeforeAll');
        this.sendMessage({ command: _command_types2.default.READY });
      });

      function initialize(_x) {
        return _ref3.apply(this, arguments);
      }

      return initialize;
    }()
  }, {
    key: 'finalize',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* () {
        yield this.runTestRunHooks('afterTestRunHookDefinitions', 'an AfterAll');
        if (this.filterStacktraces) {
          this.stackTraceFilter.unfilter();
        }
        this.exit();
      });

      function finalize() {
        return _ref4.apply(this, arguments);
      }

      return finalize;
    }()
  }, {
    key: 'receiveMessage',
    value: function receiveMessage(message) {
      if (message.command === 'initialize') {
        this.initialize(message);
      } else if (message.command === 'finalize') {
        this.finalize();
      } else if (message.command === 'run') {
        this.runTestCase(message);
      }
    }
  }, {
    key: 'runTestCase',
    value: function () {
      var _ref6 = (0, _bluebird.coroutine)(function* (_ref5) {
        var testCase = _ref5.testCase,
            skip = _ref5.skip;

        var testCaseRunner = new _test_case_runner2.default({
          eventBroadcaster: this.eventBroadcaster,
          skip: skip,
          supportCodeLibrary: this.supportCodeLibrary,
          testCase: testCase,
          worldParameters: this.worldParameters
        });
        yield testCaseRunner.run();
        this.sendMessage({ command: _command_types2.default.READY });
      });

      function runTestCase(_x2) {
        return _ref6.apply(this, arguments);
      }

      return runTestCase;
    }()
  }, {
    key: 'runTestRunHooks',
    value: function () {
      var _ref7 = (0, _bluebird.coroutine)(function* (key, name) {
        var _this2 = this;

        yield _bluebird2.default.each(this.supportCodeLibrary[key], function () {
          var _ref8 = (0, _bluebird.coroutine)(function* (hookDefinition) {
            var _ref9 = yield _user_code_runner2.default.run({
              argsArray: [],
              fn: hookDefinition.code,
              thisArg: null,
              timeoutInMilliseconds: hookDefinition.options.timeout || _this2.supportCodeLibrary.defaultTimeout
            }),
                error = _ref9.error;

            if (error) {
              var location = (0, _helpers.formatLocation)(hookDefinition);
              throw new _verror2.default(error, name + ' hook errored, process exiting: ' + location);
            }
          });

          return function (_x5) {
            return _ref8.apply(this, arguments);
          };
        }());
      });

      function runTestRunHooks(_x3, _x4) {
        return _ref7.apply(this, arguments);
      }

      return runTestRunHooks;
    }()
  }]);
  return Slave;
}();

exports.default = Slave;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9ydW50aW1lL3BhcmFsbGVsL3NsYXZlLmpzIl0sIm5hbWVzIjpbIkVWRU5UUyIsInNlcmlhbGl6ZVJlc3VsdEV4Y2VwdGlvbklmTmVjZXNzYXJ5IiwiZGF0YSIsInJlc3VsdCIsImV4Y2VwdGlvbiIsImlzRXJyb3IiLCJTbGF2ZSIsImN3ZCIsImV4aXQiLCJzZW5kTWVzc2FnZSIsImluaXRpYWxpemVkIiwiZXZlbnRCcm9hZGNhc3RlciIsInN0YWNrVHJhY2VGaWx0ZXIiLCJmb3JFYWNoIiwib24iLCJuYW1lIiwiY29tbWFuZCIsIkVWRU5UIiwiZmlsdGVyU3RhY2t0cmFjZXMiLCJzdXBwb3J0Q29kZVJlcXVpcmVkTW9kdWxlcyIsInN1cHBvcnRDb2RlUGF0aHMiLCJ3b3JsZFBhcmFtZXRlcnMiLCJtYXAiLCJyZXF1aXJlIiwibW9kdWxlIiwicmVzZXQiLCJjb2RlUGF0aCIsInN1cHBvcnRDb2RlTGlicmFyeSIsImZpbmFsaXplIiwiZmlsdGVyIiwicnVuVGVzdFJ1bkhvb2tzIiwiUkVBRFkiLCJ1bmZpbHRlciIsIm1lc3NhZ2UiLCJpbml0aWFsaXplIiwicnVuVGVzdENhc2UiLCJ0ZXN0Q2FzZSIsInNraXAiLCJ0ZXN0Q2FzZVJ1bm5lciIsInJ1biIsImtleSIsImVhY2giLCJob29rRGVmaW5pdGlvbiIsImFyZ3NBcnJheSIsImZuIiwiY29kZSIsInRoaXNBcmciLCJ0aW1lb3V0SW5NaWxsaXNlY29uZHMiLCJvcHRpb25zIiwidGltZW91dCIsImRlZmF1bHRUaW1lb3V0IiwiZXJyb3IiLCJsb2NhdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQSxJQUFNQSxTQUFTLENBQ2Isb0JBRGEsRUFFYixtQkFGYSxFQUdiLG1CQUhhLEVBSWIsc0JBSmEsRUFLYixvQkFMYSxFQU1iLG9CQU5hLENBQWY7O0FBU0EsU0FBU0MsbUNBQVQsQ0FBNkNDLElBQTdDLEVBQW1EO0FBQ2pELE1BQ0VBLEtBQUtDLE1BQUwsSUFDQUQsS0FBS0MsTUFBTCxDQUFZQyxTQURaLElBRUEsaUJBQUVDLE9BQUYsQ0FBVUgsS0FBS0MsTUFBTCxDQUFZQyxTQUF0QixDQUhGLEVBSUU7QUFDQUYsU0FBS0MsTUFBTCxDQUFZQyxTQUFaLEdBQXdCLDhCQUFlRixLQUFLQyxNQUFMLENBQVlDLFNBQTNCLENBQXhCO0FBQ0Q7QUFDRjs7SUFFb0JFLEs7QUFDbkIsdUJBQXdDO0FBQUE7O0FBQUEsUUFBMUJDLEdBQTBCLFFBQTFCQSxHQUEwQjtBQUFBLFFBQXJCQyxJQUFxQixRQUFyQkEsSUFBcUI7QUFBQSxRQUFmQyxXQUFlLFFBQWZBLFdBQWU7QUFBQTs7QUFDdEMsU0FBS0MsV0FBTCxHQUFtQixLQUFuQjtBQUNBLFNBQUtILEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLFdBQUwsR0FBbUJBLFdBQW5CO0FBQ0EsU0FBS0UsZ0JBQUwsR0FBd0Isc0JBQXhCO0FBQ0EsU0FBS0MsZ0JBQUwsR0FBd0Isa0NBQXhCO0FBQ0FaLFdBQU9hLE9BQVAsQ0FBZSxnQkFBUTtBQUNyQixZQUFLRixnQkFBTCxDQUFzQkcsRUFBdEIsQ0FBeUJDLElBQXpCLEVBQStCLGdCQUFRO0FBQ3JDZCw0Q0FBb0NDLElBQXBDO0FBQ0EsY0FBS08sV0FBTCxDQUFpQixFQUFFTyxTQUFTLHdCQUFhQyxLQUF4QixFQUErQkYsVUFBL0IsRUFBcUNiLFVBQXJDLEVBQWpCO0FBQ0QsT0FIRDtBQUlELEtBTEQ7QUFNRDs7Ozs7NkRBT0U7QUFBQSxZQUpEZ0IsaUJBSUMsU0FKREEsaUJBSUM7QUFBQSxZQUhEQywwQkFHQyxTQUhEQSwwQkFHQztBQUFBLFlBRkRDLGdCQUVDLFNBRkRBLGdCQUVDO0FBQUEsWUFEREMsZUFDQyxTQUREQSxlQUNDOztBQUNERixtQ0FBMkJHLEdBQTNCLENBQStCO0FBQUEsaUJBQVVDLFFBQVFDLE1BQVIsQ0FBVjtBQUFBLFNBQS9CO0FBQ0EsK0NBQTBCQyxLQUExQixDQUFnQyxLQUFLbEIsR0FBckM7QUFDQWEseUJBQWlCUCxPQUFqQixDQUF5QjtBQUFBLGlCQUFZVSxRQUFRRyxRQUFSLENBQVo7QUFBQSxTQUF6QjtBQUNBLGFBQUtDLGtCQUFMLEdBQTBCLHVDQUEwQkMsUUFBMUIsRUFBMUI7QUFDQSxhQUFLUCxlQUFMLEdBQXVCQSxlQUF2QjtBQUNBLGFBQUtILGlCQUFMLEdBQXlCQSxpQkFBekI7QUFDQSxZQUFJLEtBQUtBLGlCQUFULEVBQTRCO0FBQzFCLGVBQUtOLGdCQUFMLENBQXNCaUIsTUFBdEI7QUFDRDtBQUNELGNBQU0sS0FBS0MsZUFBTCxDQUFxQiw4QkFBckIsRUFBcUQsYUFBckQsQ0FBTjtBQUNBLGFBQUtyQixXQUFMLENBQWlCLEVBQUVPLFNBQVMsd0JBQWFlLEtBQXhCLEVBQWpCO0FBQ0QsTzs7Ozs7Ozs7Ozs7d0RBRWdCO0FBQ2YsY0FBTSxLQUFLRCxlQUFMLENBQXFCLDZCQUFyQixFQUFvRCxhQUFwRCxDQUFOO0FBQ0EsWUFBSSxLQUFLWixpQkFBVCxFQUE0QjtBQUMxQixlQUFLTixnQkFBTCxDQUFzQm9CLFFBQXRCO0FBQ0Q7QUFDRCxhQUFLeEIsSUFBTDtBQUNELE87Ozs7Ozs7Ozs7bUNBRWN5QixPLEVBQVM7QUFDdEIsVUFBSUEsUUFBUWpCLE9BQVIsS0FBb0IsWUFBeEIsRUFBc0M7QUFDcEMsYUFBS2tCLFVBQUwsQ0FBZ0JELE9BQWhCO0FBQ0QsT0FGRCxNQUVPLElBQUlBLFFBQVFqQixPQUFSLEtBQW9CLFVBQXhCLEVBQW9DO0FBQ3pDLGFBQUtZLFFBQUw7QUFDRCxPQUZNLE1BRUEsSUFBSUssUUFBUWpCLE9BQVIsS0FBb0IsS0FBeEIsRUFBK0I7QUFDcEMsYUFBS21CLFdBQUwsQ0FBaUJGLE9BQWpCO0FBQ0Q7QUFDRjs7Ozs2REFFcUM7QUFBQSxZQUFsQkcsUUFBa0IsU0FBbEJBLFFBQWtCO0FBQUEsWUFBUkMsSUFBUSxTQUFSQSxJQUFROztBQUNwQyxZQUFNQyxpQkFBaUIsK0JBQW1CO0FBQ3hDM0IsNEJBQWtCLEtBQUtBLGdCQURpQjtBQUV4QzBCLG9CQUZ3QztBQUd4Q1YsOEJBQW9CLEtBQUtBLGtCQUhlO0FBSXhDUyw0QkFKd0M7QUFLeENmLDJCQUFpQixLQUFLQTtBQUxrQixTQUFuQixDQUF2QjtBQU9BLGNBQU1pQixlQUFlQyxHQUFmLEVBQU47QUFDQSxhQUFLOUIsV0FBTCxDQUFpQixFQUFFTyxTQUFTLHdCQUFhZSxLQUF4QixFQUFqQjtBQUNELE87Ozs7Ozs7Ozs7O3NEQUVxQlMsRyxFQUFLekIsSSxFQUFNO0FBQUE7O0FBQy9CLGNBQU0sbUJBQVEwQixJQUFSLENBQWEsS0FBS2Qsa0JBQUwsQ0FBd0JhLEdBQXhCLENBQWI7QUFBQSwrQ0FBMkMsV0FBTUUsY0FBTixFQUF3QjtBQUFBLHdCQUNyRCxNQUFNLDJCQUFlSCxHQUFmLENBQW1CO0FBQ3pDSSx5QkFBVyxFQUQ4QjtBQUV6Q0Msa0JBQUlGLGVBQWVHLElBRnNCO0FBR3pDQyx1QkFBUyxJQUhnQztBQUl6Q0MscUNBQ0VMLGVBQWVNLE9BQWYsQ0FBdUJDLE9BQXZCLElBQ0EsT0FBS3RCLGtCQUFMLENBQXdCdUI7QUFOZSxhQUFuQixDQUQrQztBQUFBLGdCQUMvREMsS0FEK0QsU0FDL0RBLEtBRCtEOztBQVN2RSxnQkFBSUEsS0FBSixFQUFXO0FBQ1Qsa0JBQU1DLFdBQVcsNkJBQWVWLGNBQWYsQ0FBakI7QUFDQSxvQkFBTSxxQkFDSlMsS0FESSxFQUVEcEMsSUFGQyx3Q0FFc0NxQyxRQUZ0QyxDQUFOO0FBSUQ7QUFDRixXQWhCSzs7QUFBQTtBQUFBO0FBQUE7QUFBQSxZQUFOO0FBaUJELE87Ozs7Ozs7Ozs7OztrQkFuRmtCOUMsSyIsImZpbGUiOiJzbGF2ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCdcbmltcG9ydCB7IGZvcm1hdExvY2F0aW9uIH0gZnJvbSAnLi4vLi4vZm9ybWF0dGVyL2hlbHBlcnMnXG5pbXBvcnQgY29tbWFuZFR5cGVzIGZyb20gJy4vY29tbWFuZF90eXBlcydcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJ1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgc2VyaWFsaXplRXJyb3IgZnJvbSAnc2VyaWFsaXplLWVycm9yJ1xuaW1wb3J0IFN0YWNrVHJhY2VGaWx0ZXIgZnJvbSAnLi4vc3RhY2tfdHJhY2VfZmlsdGVyJ1xuaW1wb3J0IHN1cHBvcnRDb2RlTGlicmFyeUJ1aWxkZXIgZnJvbSAnLi4vLi4vc3VwcG9ydF9jb2RlX2xpYnJhcnlfYnVpbGRlcidcbmltcG9ydCBUZXN0Q2FzZVJ1bm5lciBmcm9tICcuLi90ZXN0X2Nhc2VfcnVubmVyJ1xuaW1wb3J0IFVzZXJDb2RlUnVubmVyIGZyb20gJy4uLy4uL3VzZXJfY29kZV9ydW5uZXInXG5pbXBvcnQgVkVycm9yIGZyb20gJ3ZlcnJvcidcblxuY29uc3QgRVZFTlRTID0gW1xuICAndGVzdC1jYXNlLXByZXBhcmVkJyxcbiAgJ3Rlc3QtY2FzZS1zdGFydGVkJyxcbiAgJ3Rlc3Qtc3RlcC1zdGFydGVkJyxcbiAgJ3Rlc3Qtc3RlcC1hdHRhY2htZW50JyxcbiAgJ3Rlc3Qtc3RlcC1maW5pc2hlZCcsXG4gICd0ZXN0LWNhc2UtZmluaXNoZWQnLFxuXVxuXG5mdW5jdGlvbiBzZXJpYWxpemVSZXN1bHRFeGNlcHRpb25JZk5lY2Vzc2FyeShkYXRhKSB7XG4gIGlmIChcbiAgICBkYXRhLnJlc3VsdCAmJlxuICAgIGRhdGEucmVzdWx0LmV4Y2VwdGlvbiAmJlxuICAgIF8uaXNFcnJvcihkYXRhLnJlc3VsdC5leGNlcHRpb24pXG4gICkge1xuICAgIGRhdGEucmVzdWx0LmV4Y2VwdGlvbiA9IHNlcmlhbGl6ZUVycm9yKGRhdGEucmVzdWx0LmV4Y2VwdGlvbilcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTbGF2ZSB7XG4gIGNvbnN0cnVjdG9yKHsgY3dkLCBleGl0LCBzZW5kTWVzc2FnZSB9KSB7XG4gICAgdGhpcy5pbml0aWFsaXplZCA9IGZhbHNlXG4gICAgdGhpcy5jd2QgPSBjd2RcbiAgICB0aGlzLmV4aXQgPSBleGl0XG4gICAgdGhpcy5zZW5kTWVzc2FnZSA9IHNlbmRNZXNzYWdlXG4gICAgdGhpcy5ldmVudEJyb2FkY2FzdGVyID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gICAgdGhpcy5zdGFja1RyYWNlRmlsdGVyID0gbmV3IFN0YWNrVHJhY2VGaWx0ZXIoKVxuICAgIEVWRU5UUy5mb3JFYWNoKG5hbWUgPT4ge1xuICAgICAgdGhpcy5ldmVudEJyb2FkY2FzdGVyLm9uKG5hbWUsIGRhdGEgPT4ge1xuICAgICAgICBzZXJpYWxpemVSZXN1bHRFeGNlcHRpb25JZk5lY2Vzc2FyeShkYXRhKVxuICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKHsgY29tbWFuZDogY29tbWFuZFR5cGVzLkVWRU5ULCBuYW1lLCBkYXRhIH0pXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBhc3luYyBpbml0aWFsaXplKHtcbiAgICBmaWx0ZXJTdGFja3RyYWNlcyxcbiAgICBzdXBwb3J0Q29kZVJlcXVpcmVkTW9kdWxlcyxcbiAgICBzdXBwb3J0Q29kZVBhdGhzLFxuICAgIHdvcmxkUGFyYW1ldGVycyxcbiAgfSkge1xuICAgIHN1cHBvcnRDb2RlUmVxdWlyZWRNb2R1bGVzLm1hcChtb2R1bGUgPT4gcmVxdWlyZShtb2R1bGUpKVxuICAgIHN1cHBvcnRDb2RlTGlicmFyeUJ1aWxkZXIucmVzZXQodGhpcy5jd2QpXG4gICAgc3VwcG9ydENvZGVQYXRocy5mb3JFYWNoKGNvZGVQYXRoID0+IHJlcXVpcmUoY29kZVBhdGgpKVxuICAgIHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5ID0gc3VwcG9ydENvZGVMaWJyYXJ5QnVpbGRlci5maW5hbGl6ZSgpXG4gICAgdGhpcy53b3JsZFBhcmFtZXRlcnMgPSB3b3JsZFBhcmFtZXRlcnNcbiAgICB0aGlzLmZpbHRlclN0YWNrdHJhY2VzID0gZmlsdGVyU3RhY2t0cmFjZXNcbiAgICBpZiAodGhpcy5maWx0ZXJTdGFja3RyYWNlcykge1xuICAgICAgdGhpcy5zdGFja1RyYWNlRmlsdGVyLmZpbHRlcigpXG4gICAgfVxuICAgIGF3YWl0IHRoaXMucnVuVGVzdFJ1bkhvb2tzKCdiZWZvcmVUZXN0UnVuSG9va0RlZmluaXRpb25zJywgJ2EgQmVmb3JlQWxsJylcbiAgICB0aGlzLnNlbmRNZXNzYWdlKHsgY29tbWFuZDogY29tbWFuZFR5cGVzLlJFQURZIH0pXG4gIH1cblxuICBhc3luYyBmaW5hbGl6ZSgpIHtcbiAgICBhd2FpdCB0aGlzLnJ1blRlc3RSdW5Ib29rcygnYWZ0ZXJUZXN0UnVuSG9va0RlZmluaXRpb25zJywgJ2FuIEFmdGVyQWxsJylcbiAgICBpZiAodGhpcy5maWx0ZXJTdGFja3RyYWNlcykge1xuICAgICAgdGhpcy5zdGFja1RyYWNlRmlsdGVyLnVuZmlsdGVyKClcbiAgICB9XG4gICAgdGhpcy5leGl0KClcbiAgfVxuXG4gIHJlY2VpdmVNZXNzYWdlKG1lc3NhZ2UpIHtcbiAgICBpZiAobWVzc2FnZS5jb21tYW5kID09PSAnaW5pdGlhbGl6ZScpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZShtZXNzYWdlKVxuICAgIH0gZWxzZSBpZiAobWVzc2FnZS5jb21tYW5kID09PSAnZmluYWxpemUnKSB7XG4gICAgICB0aGlzLmZpbmFsaXplKClcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2UuY29tbWFuZCA9PT0gJ3J1bicpIHtcbiAgICAgIHRoaXMucnVuVGVzdENhc2UobWVzc2FnZSlcbiAgICB9XG4gIH1cblxuICBhc3luYyBydW5UZXN0Q2FzZSh7IHRlc3RDYXNlLCBza2lwIH0pIHtcbiAgICBjb25zdCB0ZXN0Q2FzZVJ1bm5lciA9IG5ldyBUZXN0Q2FzZVJ1bm5lcih7XG4gICAgICBldmVudEJyb2FkY2FzdGVyOiB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIsXG4gICAgICBza2lwLFxuICAgICAgc3VwcG9ydENvZGVMaWJyYXJ5OiB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeSxcbiAgICAgIHRlc3RDYXNlLFxuICAgICAgd29ybGRQYXJhbWV0ZXJzOiB0aGlzLndvcmxkUGFyYW1ldGVycyxcbiAgICB9KVxuICAgIGF3YWl0IHRlc3RDYXNlUnVubmVyLnJ1bigpXG4gICAgdGhpcy5zZW5kTWVzc2FnZSh7IGNvbW1hbmQ6IGNvbW1hbmRUeXBlcy5SRUFEWSB9KVxuICB9XG5cbiAgYXN5bmMgcnVuVGVzdFJ1bkhvb2tzKGtleSwgbmFtZSkge1xuICAgIGF3YWl0IFByb21pc2UuZWFjaCh0aGlzLnN1cHBvcnRDb2RlTGlicmFyeVtrZXldLCBhc3luYyBob29rRGVmaW5pdGlvbiA9PiB7XG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBVc2VyQ29kZVJ1bm5lci5ydW4oe1xuICAgICAgICBhcmdzQXJyYXk6IFtdLFxuICAgICAgICBmbjogaG9va0RlZmluaXRpb24uY29kZSxcbiAgICAgICAgdGhpc0FyZzogbnVsbCxcbiAgICAgICAgdGltZW91dEluTWlsbGlzZWNvbmRzOlxuICAgICAgICAgIGhvb2tEZWZpbml0aW9uLm9wdGlvbnMudGltZW91dCB8fFxuICAgICAgICAgIHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5LmRlZmF1bHRUaW1lb3V0LFxuICAgICAgfSlcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBjb25zdCBsb2NhdGlvbiA9IGZvcm1hdExvY2F0aW9uKGhvb2tEZWZpbml0aW9uKVxuICAgICAgICB0aHJvdyBuZXcgVkVycm9yKFxuICAgICAgICAgIGVycm9yLFxuICAgICAgICAgIGAke25hbWV9IGhvb2sgZXJyb3JlZCwgcHJvY2VzcyBleGl0aW5nOiAke2xvY2F0aW9ufWBcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH0pXG4gIH1cbn1cbiJdfQ==