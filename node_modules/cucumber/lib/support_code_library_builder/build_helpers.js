'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.buildTestCaseHookDefinition = buildTestCaseHookDefinition;
exports.buildTestRunHookDefinition = buildTestRunHookDefinition;
exports.buildStepDefinitionConfig = buildStepDefinitionConfig;
exports.buildStepDefinitionFromConfig = buildStepDefinitionFromConfig;
exports.buildParameterType = buildParameterType;

var _util = require('util');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _helpers = require('../formatter/helpers');

var _cucumberExpressions = require('cucumber-expressions');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _stacktraceJs = require('stacktrace-js');

var _stacktraceJs2 = _interopRequireDefault(_stacktraceJs);

var _step_definition = require('../models/step_definition');

var _step_definition2 = _interopRequireDefault(_step_definition);

var _test_case_hook_definition = require('../models/test_case_hook_definition');

var _test_case_hook_definition2 = _interopRequireDefault(_test_case_hook_definition);

var _test_run_hook_definition = require('../models/test_run_hook_definition');

var _test_run_hook_definition2 = _interopRequireDefault(_test_run_hook_definition);

var _validate_arguments = require('./validate_arguments');

var _validate_arguments2 = _interopRequireDefault(_validate_arguments);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function buildTestCaseHookDefinition(_ref) {
  var options = _ref.options,
      code = _ref.code,
      cwd = _ref.cwd;

  if (typeof options === 'string') {
    options = { tags: options };
  } else if (typeof options === 'function') {
    code = options;
    options = {};
  }

  var _getDefinitionLineAnd = getDefinitionLineAndUri(cwd),
      line = _getDefinitionLineAnd.line,
      uri = _getDefinitionLineAnd.uri;

  (0, _validate_arguments2.default)({
    args: { code: code, options: options },
    fnName: 'defineTestCaseHook',
    location: (0, _helpers.formatLocation)({ line: line, uri: uri })
  });
  return new _test_case_hook_definition2.default({
    code: code,
    line: line,
    options: options,
    uri: uri
  });
}

function buildTestRunHookDefinition(_ref2) {
  var options = _ref2.options,
      code = _ref2.code,
      cwd = _ref2.cwd;

  if (typeof options === 'string') {
    options = { tags: options };
  } else if (typeof options === 'function') {
    code = options;
    options = {};
  }

  var _getDefinitionLineAnd2 = getDefinitionLineAndUri(cwd),
      line = _getDefinitionLineAnd2.line,
      uri = _getDefinitionLineAnd2.uri;

  (0, _validate_arguments2.default)({
    args: { code: code, options: options },
    fnName: 'defineTestRunHook',
    location: (0, _helpers.formatLocation)({ line: line, uri: uri })
  });
  return new _test_run_hook_definition2.default({
    code: code,
    line: line,
    options: options,
    uri: uri
  });
}

function buildStepDefinitionConfig(_ref3) {
  var pattern = _ref3.pattern,
      options = _ref3.options,
      code = _ref3.code,
      cwd = _ref3.cwd;

  if (typeof options === 'function') {
    code = options;
    options = {};
  }

  var _getDefinitionLineAnd3 = getDefinitionLineAndUri(cwd),
      line = _getDefinitionLineAnd3.line,
      uri = _getDefinitionLineAnd3.uri;

  (0, _validate_arguments2.default)({
    args: { code: code, pattern: pattern, options: options },
    fnName: 'defineStep',
    location: (0, _helpers.formatLocation)({ line: line, uri: uri })
  });
  return {
    code: code,
    line: line,
    options: options,
    pattern: pattern,
    uri: uri
  };
}

function buildStepDefinitionFromConfig(_ref4) {
  var config = _ref4.config,
      parameterTypeRegistry = _ref4.parameterTypeRegistry;
  var code = config.code,
      line = config.line,
      options = config.options,
      uri = config.uri,
      pattern = config.pattern;

  var Expression = typeof pattern === 'string' ? _cucumberExpressions.CucumberExpression : _cucumberExpressions.RegularExpression;

  var expression = new Expression(pattern, parameterTypeRegistry);
  return new _step_definition2.default({ code: code, line: line, options: options, uri: uri, pattern: pattern, expression: expression });
}

var projectPath = _path2.default.join(__dirname, '..', '..');
var projectSrcPath = _path2.default.join(projectPath, 'src');
var projectLibPath = _path2.default.join(projectPath, 'lib');

function getDefinitionLineAndUri(cwd) {
  var line = 'unknown';
  var uri = 'unknown';
  var stackframes = _stacktraceJs2.default.getSync();
  var stackframe = _lodash2.default.find(stackframes, function (frame) {
    var filename = frame.getFileName();
    return !_lodash2.default.includes(filename, projectSrcPath) && !_lodash2.default.includes(filename, projectLibPath);
  });
  if (stackframe) {
    line = stackframe.getLineNumber();
    uri = stackframe.getFileName();
    if (uri) {
      uri = _path2.default.relative(cwd, uri);
    }
  }
  return { line: line, uri: uri };
}

function buildParameterType(_ref5) {
  var name = _ref5.name,
      typeName = _ref5.typeName,
      regexp = _ref5.regexp,
      transformer = _ref5.transformer,
      useForSnippets = _ref5.useForSnippets,
      preferForRegexpMatch = _ref5.preferForRegexpMatch;

  var getTypeName = (0, _util.deprecate)(function () {
    return typeName;
  }, 'Cucumber defineParameterType: Use name instead of typeName');
  var _name = name || getTypeName();
  if (typeof useForSnippets !== 'boolean') useForSnippets = true;
  if (typeof preferForRegexpMatch !== 'boolean') preferForRegexpMatch = false;
  return new _cucumberExpressions.ParameterType(_name, regexp, null, transformer, useForSnippets, preferForRegexpMatch);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdXBwb3J0X2NvZGVfbGlicmFyeV9idWlsZGVyL2J1aWxkX2hlbHBlcnMuanMiXSwibmFtZXMiOlsiYnVpbGRUZXN0Q2FzZUhvb2tEZWZpbml0aW9uIiwiYnVpbGRUZXN0UnVuSG9va0RlZmluaXRpb24iLCJidWlsZFN0ZXBEZWZpbml0aW9uQ29uZmlnIiwiYnVpbGRTdGVwRGVmaW5pdGlvbkZyb21Db25maWciLCJidWlsZFBhcmFtZXRlclR5cGUiLCJvcHRpb25zIiwiY29kZSIsImN3ZCIsInRhZ3MiLCJnZXREZWZpbml0aW9uTGluZUFuZFVyaSIsImxpbmUiLCJ1cmkiLCJhcmdzIiwiZm5OYW1lIiwibG9jYXRpb24iLCJwYXR0ZXJuIiwiY29uZmlnIiwicGFyYW1ldGVyVHlwZVJlZ2lzdHJ5IiwiRXhwcmVzc2lvbiIsImV4cHJlc3Npb24iLCJwcm9qZWN0UGF0aCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJwcm9qZWN0U3JjUGF0aCIsInByb2plY3RMaWJQYXRoIiwic3RhY2tmcmFtZXMiLCJnZXRTeW5jIiwic3RhY2tmcmFtZSIsImZpbmQiLCJmaWxlbmFtZSIsImZyYW1lIiwiZ2V0RmlsZU5hbWUiLCJpbmNsdWRlcyIsImdldExpbmVOdW1iZXIiLCJyZWxhdGl2ZSIsIm5hbWUiLCJ0eXBlTmFtZSIsInJlZ2V4cCIsInRyYW5zZm9ybWVyIiwidXNlRm9yU25pcHBldHMiLCJwcmVmZXJGb3JSZWdleHBNYXRjaCIsImdldFR5cGVOYW1lIiwiX25hbWUiXSwibWFwcGluZ3MiOiI7Ozs7O1FBZWdCQSwyQixHQUFBQSwyQjtRQXFCQUMsMEIsR0FBQUEsMEI7UUFxQkFDLHlCLEdBQUFBLHlCO1FBb0JBQyw2QixHQUFBQSw2QjtRQXFDQUMsa0IsR0FBQUEsa0I7O0FBbEhoQjs7QUFDQTs7OztBQUNBOztBQUNBOztBQUtBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRU8sU0FBU0osMkJBQVQsT0FBNkQ7QUFB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QUlHLFVBQUosRUFBZ0I7QUFDZGpCLFdBQU9pQixXQUFXTSxhQUFYLEVBQVA7QUFDQXRCLFVBQU1nQixXQUFXSSxXQUFYLEVBQU47QUFDQSxRQUFJcEIsR0FBSixFQUFTO0FBQ1BBLFlBQU0sZUFBS3VCLFFBQUwsQ0FBYzNCLEdBQWQsRUFBbUJJLEdBQW5CLENBQU47QUFDRDtBQUNGO0FBQ0QsU0FBTyxFQUFFRCxVQUFGLEVBQVFDLFFBQVIsRUFBUDtBQUNEOztBQUVNLFNBQVNQLGtCQUFULFFBT0o7QUFBQSxNQU5EK0IsSUFNQyxTQU5EQSxJQU1DO0FBQUEsTUFMREMsUUFLQyxTQUxEQSxRQUtDO0FBQUEsTUFKREMsTUFJQyxTQUpEQSxNQUlDO0FBQUEsTUFIREMsV0FHQyxTQUhEQSxXQUdDO0FBQUEsTUFGREMsY0FFQyxTQUZEQSxjQUVDO0FBQUEsTUFEREMsb0JBQ0MsU0FEREEsb0JBQ0M7O0FBQ0QsTUFBTUMsY0FBYyxxQkFDbEI7QUFBQSxXQUFNTCxRQUFOO0FBQUEsR0FEa0IsRUFFbEIsNERBRmtCLENBQXBCO0FBSUEsTUFBTU0sUUFBUVAsUUFBUU0sYUFBdEI7QUFDQSxNQUFJLE9BQU9GLGNBQVAsS0FBMEIsU0FBOUIsRUFBeUNBLGlCQUFpQixJQUFqQjtBQUN6QyxNQUFJLE9BQU9DLG9CQUFQLEtBQWdDLFNBQXBDLEVBQStDQSx1QkFBdUIsS0FBdkI7QUFDL0MsU0FBTyx1Q0FDTEUsS0FESyxFQUVMTCxNQUZLLEVBR0wsSUFISyxFQUlMQyxXQUpLLEVBS0xDLGNBTEssRUFNTEMsb0JBTkssQ0FBUDtBQVFEIiwiZmlsZSI6ImJ1aWxkX2hlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZXByZWNhdGUgfSBmcm9tICd1dGlsJ1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuaW1wb3J0IHsgZm9ybWF0TG9jYXRpb24gfSBmcm9tICcuLi9mb3JtYXR0ZXIvaGVscGVycydcbmltcG9ydCB7XG4gIFBhcmFtZXRlclR5cGUsXG4gIEN1Y3VtYmVyRXhwcmVzc2lvbixcbiAgUmVndWxhckV4cHJlc3Npb24sXG59IGZyb20gJ2N1Y3VtYmVyLWV4cHJlc3Npb25zJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBTdGFja1RyYWNlIGZyb20gJ3N0YWNrdHJhY2UtanMnXG5pbXBvcnQgU3RlcERlZmluaXRpb24gZnJvbSAnLi4vbW9kZWxzL3N0ZXBfZGVmaW5pdGlvbidcbmltcG9ydCBUZXN0Q2FzZUhvb2tEZWZpbml0aW9uIGZyb20gJy4uL21vZGVscy90ZXN0X2Nhc2VfaG9va19kZWZpbml0aW9uJ1xuaW1wb3J0IFRlc3RSdW5Ib29rRGVmaW5pdGlvbiBmcm9tICcuLi9tb2RlbHMvdGVzdF9ydW5faG9va19kZWZpbml0aW9uJ1xuaW1wb3J0IHZhbGlkYXRlQXJndW1lbnRzIGZyb20gJy4vdmFsaWRhdGVfYXJndW1lbnRzJ1xuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRUZXN0Q2FzZUhvb2tEZWZpbml0aW9uKHsgb3B0aW9ucywgY29kZSwgY3dkIH0pIHtcbiAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykge1xuICAgIG9wdGlvbnMgPSB7IHRhZ3M6IG9wdGlvbnMgfVxuICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY29kZSA9IG9wdGlvbnNcbiAgICBvcHRpb25zID0ge31cbiAgfVxuICBjb25zdCB7IGxpbmUsIHVyaSB9ID0gZ2V0RGVmaW5pdGlvbkxpbmVBbmRVcmkoY3dkKVxuICB2YWxpZGF0ZUFyZ3VtZW50cyh7XG4gICAgYXJnczogeyBjb2RlLCBvcHRpb25zIH0sXG4gICAgZm5OYW1lOiAnZGVmaW5lVGVzdENhc2VIb29rJyxcbiAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSksXG4gIH0pXG4gIHJldHVybiBuZXcgVGVzdENhc2VIb29rRGVmaW5pdGlvbih7XG4gICAgY29kZSxcbiAgICBsaW5lLFxuICAgIG9wdGlvbnMsXG4gICAgdXJpLFxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRUZXN0UnVuSG9va0RlZmluaXRpb24oeyBvcHRpb25zLCBjb2RlLCBjd2QgfSkge1xuICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgb3B0aW9ucyA9IHsgdGFnczogb3B0aW9ucyB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb2RlID0gb3B0aW9uc1xuICAgIG9wdGlvbnMgPSB7fVxuICB9XG4gIGNvbnN0IHsgbGluZSwgdXJpIH0gPSBnZXREZWZpbml0aW9uTGluZUFuZFVyaShjd2QpXG4gIHZhbGlkYXRlQXJndW1lbnRzKHtcbiAgICBhcmdzOiB7IGNvZGUsIG9wdGlvbnMgfSxcbiAgICBmbk5hbWU6ICdkZWZpbmVUZXN0UnVuSG9vaycsXG4gICAgbG9jYXRpb246IGZvcm1hdExvY2F0aW9uKHsgbGluZSwgdXJpIH0pLFxuICB9KVxuICByZXR1cm4gbmV3IFRlc3RSdW5Ib29rRGVmaW5pdGlvbih7XG4gICAgY29kZSxcbiAgICBsaW5lLFxuICAgIG9wdGlvbnMsXG4gICAgdXJpLFxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRTdGVwRGVmaW5pdGlvbkNvbmZpZyh7IHBhdHRlcm4sIG9wdGlvbnMsIGNvZGUsIGN3ZCB9KSB7XG4gIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGNvZGUgPSBvcHRpb25zXG4gICAgb3B0aW9ucyA9IHt9XG4gIH1cbiAgY29uc3QgeyBsaW5lLCB1cmkgfSA9IGdldERlZmluaXRpb25MaW5lQW5kVXJpKGN3ZClcbiAgdmFsaWRhdGVBcmd1bWVudHMoe1xuICAgIGFyZ3M6IHsgY29kZSwgcGF0dGVybiwgb3B0aW9ucyB9LFxuICAgIGZuTmFtZTogJ2RlZmluZVN0ZXAnLFxuICAgIGxvY2F0aW9uOiBmb3JtYXRMb2NhdGlvbih7IGxpbmUsIHVyaSB9KSxcbiAgfSlcbiAgcmV0dXJuIHtcbiAgICBjb2RlLFxuICAgIGxpbmUsXG4gICAgb3B0aW9ucyxcbiAgICBwYXR0ZXJuLFxuICAgIHVyaSxcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRTdGVwRGVmaW5pdGlvbkZyb21Db25maWcoe1xuICBjb25maWcsXG4gIHBhcmFtZXRlclR5cGVSZWdpc3RyeSxcbn0pIHtcbiAgY29uc3QgeyBjb2RlLCBsaW5lLCBvcHRpb25zLCB1cmksIHBhdHRlcm4gfSA9IGNvbmZpZ1xuICBjb25zdCBFeHByZXNzaW9uID1cbiAgICB0eXBlb2YgcGF0dGVybiA9PT0gJ3N0cmluZycgPyBDdWN1bWJlckV4cHJlc3Npb24gOiBSZWd1bGFyRXhwcmVzc2lvblxuXG4gIGNvbnN0IGV4cHJlc3Npb24gPSBuZXcgRXhwcmVzc2lvbihwYXR0ZXJuLCBwYXJhbWV0ZXJUeXBlUmVnaXN0cnkpXG4gIHJldHVybiBuZXcgU3RlcERlZmluaXRpb24oeyBjb2RlLCBsaW5lLCBvcHRpb25zLCB1cmksIHBhdHRlcm4sIGV4cHJlc3Npb24gfSlcbn1cblxuY29uc3QgcHJvamVjdFBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nKVxuY29uc3QgcHJvamVjdFNyY1BhdGggPSBwYXRoLmpvaW4ocHJvamVjdFBhdGgsICdzcmMnKVxuY29uc3QgcHJvamVjdExpYlBhdGggPSBwYXRoLmpvaW4ocHJvamVjdFBhdGgsICdsaWInKVxuXG5mdW5jdGlvbiBnZXREZWZpbml0aW9uTGluZUFuZFVyaShjd2QpIHtcbiAgbGV0IGxpbmUgPSAndW5rbm93bidcbiAgbGV0IHVyaSA9ICd1bmtub3duJ1xuICBjb25zdCBzdGFja2ZyYW1lcyA9IFN0YWNrVHJhY2UuZ2V0U3luYygpXG4gIGNvbnN0IHN0YWNrZnJhbWUgPSBfLmZpbmQoc3RhY2tmcmFtZXMsIGZyYW1lID0+IHtcbiAgICBjb25zdCBmaWxlbmFtZSA9IGZyYW1lLmdldEZpbGVOYW1lKClcbiAgICByZXR1cm4gKFxuICAgICAgIV8uaW5jbHVkZXMoZmlsZW5hbWUsIHByb2plY3RTcmNQYXRoKSAmJlxuICAgICAgIV8uaW5jbHVkZXMoZmlsZW5hbWUsIHByb2plY3RMaWJQYXRoKVxuICAgIClcbiAgfSlcbiAgaWYgKHN0YWNrZnJhbWUpIHtcbiAgICBsaW5lID0gc3RhY2tmcmFtZS5nZXRMaW5lTnVtYmVyKClcbiAgICB1cmkgPSBzdGFja2ZyYW1lLmdldEZpbGVOYW1lKClcbiAgICBpZiAodXJpKSB7XG4gICAgICB1cmkgPSBwYXRoLnJlbGF0aXZlKGN3ZCwgdXJpKVxuICAgIH1cbiAgfVxuICByZXR1cm4geyBsaW5lLCB1cmkgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRQYXJhbWV0ZXJUeXBlKHtcbiAgbmFtZSxcbiAgdHlwZU5hbWUsXG4gIHJlZ2V4cCxcbiAgdHJhbnNmb3JtZXIsXG4gIHVzZUZvclNuaXBwZXRzLFxuICBwcmVmZXJGb3JSZWdleHBNYXRjaCxcbn0pIHtcbiAgY29uc3QgZ2V0VHlwZU5hbWUgPSBkZXByZWNhdGUoXG4gICAgKCkgPT4gdHlwZU5hbWUsXG4gICAgJ0N1Y3VtYmVyIGRlZmluZVBhcmFtZXRlclR5cGU6IFVzZSBuYW1lIGluc3RlYWQgb2YgdHlwZU5hbWUnXG4gIClcbiAgY29uc3QgX25hbWUgPSBuYW1lIHx8IGdldFR5cGVOYW1lKClcbiAgaWYgKHR5cGVvZiB1c2VGb3JTbmlwcGV0cyAhPT0gJ2Jvb2xlYW4nKSB1c2VGb3JTbmlwcGV0cyA9IHRydWVcbiAgaWYgKHR5cGVvZiBwcmVmZXJGb3JSZWdleHBNYXRjaCAhPT0gJ2Jvb2xlYW4nKSBwcmVmZXJGb3JSZWdleHBNYXRjaCA9IGZhbHNlXG4gIHJldHVybiBuZXcgUGFyYW1ldGVyVHlwZShcbiAgICBfbmFtZSxcbiAgICByZWdleHAsXG4gICAgbnVsbCxcbiAgICB0cmFuc2Zvcm1lcixcbiAgICB1c2VGb3JTbmlwcGV0cyxcbiAgICBwcmVmZXJGb3JSZWdleHBNYXRjaFxuICApXG59XG4iXX0=